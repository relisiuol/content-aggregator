name: Coding Standards

on:
    pull_request:
        branches: [master]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Check Coding Standards
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                node-version: [20.x]
                os: [ubuntu-latest]
                php: [8.2]
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  tools: composer
                  extensions: mysql
                  coverage: none

            - name: Check composer
              run: composer validate

            - name: Install dependencies
              run: pnpm install

            - name: Lint
              run: pnpm run lint

            - name: Build assets
              run: pnpm run build

            - name: Create artifacts
              run: pnpm run plugin-zip

            - name: Unzip package for WP.org deploy
              run: |
                  rm -rf dist
                  mkdir -p dist
                  unzip -q content-aggregator.zip -d dist
                  if [ ! -d "dist/content-aggregator" ]; then
                      mkdir -p dist/content-aggregator
                      shopt -s dotglob
                      mv dist/* dist/content-aggregator/ || true
                  fi

            - name: Plugin Check
              uses: swissspidy/wp-plugin-check-action@v1
              with:
                  build-dir: './dist/content-aggregator/'
